<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dots Connection ‚Äî –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
<style>
  :root{
    --bg:#0a0a0a;
    --accent:#fff;
    --primary:#d17a6f;
    --secondary:#7fa5b8;
    --tertiary:#e8b86d;
    --purple:#9b89b3;
    --p1:#7fa5b8;
    --p2:#d17a6f;
  }
  
  * {box-sizing:border-box;}
  
  html,body{height:100%;margin:0;font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;overflow:hidden;}
  body{
    background:#2c3440;
    color:var(--accent);
  }
  
  /* Menu Screen */
  .menu{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:2000;
  }
  
  .menu-content{
    text-align:center;
    padding:40px;
    max-width:600px;
  }
  
  .logo {
    width:80px;
    height:80px;
    margin:0 auto 30px;
    background:rgba(255,255,255,0.05);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    border:2px solid rgba(255,255,255,0.1);
  }
  
  .logo-icon {
    font-size:48px;
  }
  
  .menu-title{
    font-size:72px;
    font-weight:900;
    margin-bottom:10px;
    background:linear-gradient(135deg,#7fa5b8,#d17a6f,#e8b86d);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    letter-spacing:-1px;
  }
  
  .menu-subtitle{
    font-size:16px;
    color:rgba(255,255,255,0.4);
    margin-bottom:50px;
    font-weight:300;
  }
  
  .mode-select{
    display:flex;
    gap:20px;
    margin-bottom:30px;
  }
  
  .mode-btn{
    flex:1;
    padding:30px 20px;
    background:rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.1);
    border-radius:16px;
    cursor:pointer;
    transition:all 0.3s;
  }
  
  .mode-btn:hover{
    background:rgba(255,255,255,0.06);
    border-color:rgba(255,255,255,0.2);
    transform:translateY(-2px);
  }
  
  .mode-btn.active{
    border-color:#7fa5b8;
    background:rgba(127,165,184,0.1);
  }
  
  .mode-icon{font-size:48px;margin-bottom:10px;}
  .mode-name{font-size:20px;font-weight:600;margin-bottom:5px;color:#fff;}
  .mode-desc{font-size:14px;color:rgba(255,255,255,0.4);}
  
  .start-btn{
    background:linear-gradient(135deg,#7fa5b8,#6a8fa3);
    color:#fff;
    border:none;
    padding:18px 60px;
    border-radius:50px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    box-shadow:0 8px 24px rgba(127,165,184,0.3);
  }
  
  .start-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 32px rgba(127,165,184,0.4);
  }
  
  /* Game Layout */
  .game-container{
    display:flex;
    height:100vh;
    position:relative;
    z-index:1;
  }
  
  .player-area{
    flex:1;
    display:flex;
    flex-direction:column;
    padding:20px;
    position:relative;
  }
  
  /* Player Header */
  .player-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:15px;
  }
  
  .player-name{
    font-size:20px;
    font-weight:600;
    display:flex;
    align-items:center;
    gap:10px;
    color:rgba(255,255,255,0.9);
  }
  
  .player-name.p1{color:#7fa5b8;}
  .player-name.p2{color:#d17a6f;}
  .player-icon{font-size:24px;}
  
  /* Stats Bar */
  .stats-bar{
    display:flex;
    gap:15px;
    margin-bottom:15px;
  }
  
  .stat{
    flex:1;
    background:rgba(255,255,255,0.03);
    padding:12px;
    border-radius:12px;
    text-align:center;
    border:1px solid rgba(255,255,255,0.1);
  }
  
  .stat-label{
    font-size:11px;
    color:rgba(255,255,255,0.4);
    text-transform:uppercase;
    font-weight:600;
    letter-spacing:1px;
  }
  
  .stat-value{
    font-size:28px;
    font-weight:700;
    margin-top:4px;
    color:#fff;
    transition:all 0.3s;
  }
  
  .stat-value.bonus{color:#7fa5b8;transform:scale(1.1);}
  .stat-value.penalty{color:#d17a6f;transform:scale(1.1);}
  
  /* Round Indicators */
  .rounds{
    display:flex;
    gap:10px;
    justify-content:center;
    margin-bottom:15px;
  }
  
  .round{
    width:45px;
    height:45px;
    border-radius:50%;
    border:2px solid rgba(255,255,255,0.15);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:18px;
    transition:all 0.3s;
    background:rgba(255,255,255,0.03);
    color:rgba(255,255,255,0.5);
  }
  
  .round.active{
    transform:scale(1.15);
  }
  
  .round.completed{
    background:#7fa5b8;
    border-color:#7fa5b8;
    color:#000;
  }
  
  .round.p1.active{border-color:#7fa5b8;color:#7fa5b8;background:rgba(127,165,184,0.1);}
  .round.p2.active{border-color:#d17a6f;color:#d17a6f;background:rgba(209,122,111,0.1);}
  
  /* Timer */
  .timer-bar{
    width:100%;
    height:8px;
    background:rgba(255,255,255,0.05);
    border-radius:10px;
    overflow:hidden;
    margin-bottom:10px;
  }
  
  .timer-fill{
    height:100%;
    background:linear-gradient(90deg,#7fa5b8,#e8b86d,#d17a6f);
    transition:width 0.5s linear;
    border-radius:10px;
  }
  
  .timer-text{
    text-align:center;
    font-size:18px;
    font-weight:600;
    margin-bottom:15px;
    color:rgba(255,255,255,0.8);
  }
  
  .timer-text.warning{color:#d17a6f;animation:pulse 1s infinite;}
  
  /* Canvas - 3D Board style */
  canvas{
    touch-action:none;
    display:block;
    border-radius:24px;
    margin:0 auto;
    background:linear-gradient(145deg, #1a1f28 0%, #0f1319 100%);
    border:8px solid #1f2530;
    box-shadow:
      0 20px 60px rgba(0,0,0,0.5),
      inset 0 1px 0 rgba(255,255,255,0.05),
      inset 0 -2px 8px rgba(0,0,0,0.3);
    position:relative;
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –ª—É—á—à–µ–≥–æ —Ç–∞—á–∞ */
    min-height:300px;
  }
  
  /* Combo Animations */
  .combo{
    position:absolute;
    font-size:24px;
    font-weight:bold;
    pointer-events:none;
    animation:comboAnim 1s ease-out forwards;
    z-index:100;
    text-shadow:2px 2px 4px rgba(0,0,0,0.3);
  }
  
  .combo.p1{color:#4ecdc4;}
  .combo.p2{color:#ff6b6b;}
  
  /* Center Divider */
  .divider{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.05);
    padding:20px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10;
    border:1px solid rgba(255,255,255,0.1);
  }
  
  .vs-text{
    font-size:32px;
    font-weight:900;
    background:linear-gradient(135deg,#7fa5b8,#d17a6f);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  
  /* Modals */
  .modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.95);
    display:none;
    align-items:center;
    justify-content:center;
    backdrop-filter:blur(10px);
    z-index:3000;
  }
  
  .modal-content{
    text-align:center;
    color:#fff;
    padding:50px;
    max-width:600px;
    background:rgba(255,255,255,0.03);
    border-radius:24px;
    border:1px solid rgba(255,255,255,0.1);
  }
  
  .modal-title{
    font-size:56px;
    margin-bottom:20px;
    animation:glow 2s infinite alternate;
    font-weight:900;
  }
  
  .modal-subtitle{
    font-size:18px;
    color:rgba(255,255,255,0.5);
    margin-bottom:30px;
    font-weight:300;
  }
  
  .modal-stats{
    background:rgba(255,255,255,0.03);
    border-radius:16px;
    padding:30px;
    margin:30px 0;
    border:1px solid rgba(255,255,255,0.05);
  }
  
  .stat-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin:15px 0;
    padding:15px;
    border-bottom:1px solid rgba(255,255,255,0.05);
    border-radius:10px;
  }
  
  .stat-row:last-child{border-bottom:none;}
  .stat-row.winner{background:rgba(127,165,184,0.1);border:1px solid rgba(127,165,184,0.3);}
  .stat-row.final{border-top:2px solid rgba(127,165,184,0.3);padding-top:20px;margin-top:20px;}
  
  .stat-label{font-size:18px;color:rgba(255,255,255,0.5);}
  .stat-label.player{font-weight:600;font-size:22px;color:rgba(255,255,255,0.8);}
  .stat-label.p1{color:#7fa5b8;}
  .stat-label.p2{color:#d17a6f;}
  .stat-score{font-weight:700;font-size:26px;}
  .stat-score.p1{color:#7fa5b8;}
  .stat-score.p2{color:#d17a6f;}
  
  .modal-btn{
    background:linear-gradient(135deg,#7fa5b8,#6a8fa3);
    color:#fff;
    border:none;
    padding:16px 40px;
    border-radius:50px;
    font-size:18px;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s;
    margin:10px;
    box-shadow:0 8px 24px rgba(127,165,184,0.3);
  }
  
  .modal-btn:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 32px rgba(127,165,184,0.4);
  }
  
  .modal-btn.secondary{
    background:rgba(255,255,255,0.05);
    box-shadow:none;
    border:1px solid rgba(255,255,255,0.1);
  }
  
  .modal-btn.secondary:hover{
    background:rgba(255,255,255,0.1);
  }
  
  .countdown{
    font-size:100px;
    font-weight:900;
    color:#7fa5b8;
    animation:countdownPulse 1s ease-in-out;
  }
  
  @keyframes pulse{0%,100%{opacity:1;} 50%{opacity:0.5;}}
  @keyframes glow{0%{text-shadow:0 0 20px rgba(255,255,255,0.5);} 
                  100%{text-shadow:0 0 40px rgba(127,165,184,0.8);}}
  @keyframes comboAnim{0%{transform:translateY(0) scale(1);opacity:1;} 
                      100%{transform:translateY(-50px) scale(1.5);opacity:0;}}
  @keyframes countdownPulse{0%{transform:scale(0.8);opacity:0;} 
                           50%{transform:scale(1.2);} 
                           100%{transform:scale(1);opacity:1;}}
  
  /* Responsive */
  @media (max-width: 768px) {
    .menu-title{font-size:48px;}
    .menu-subtitle{font-size:14px;margin-bottom:30px;}
    .mode-select{flex-direction:column;gap:15px;}
    .mode-btn{padding:20px 15px;}
    .start-btn{padding:14px 40px;font-size:16px;}
    
    .game-container{
      flex-direction:column;
      padding:0;
    }
    
    .player-area{
      padding:10px;
      min-height:auto;
    }
    
    .player-header{
      margin-bottom:8px;
    }
    
    .player-name{
      font-size:16px;
    }
    
    .player-icon{font-size:20px;}
    
    .stats-bar{
      gap:8px;
      margin-bottom:8px;
    }
    
    .stat{
      padding:8px;
    }
    
    .stat-label{
      font-size:9px;
    }
    
    .stat-value{
      font-size:20px;
    }
    
    .rounds{
      gap:6px;
      margin-bottom:8px;
    }
    
    .round{
      width:35px;
      height:35px;
      font-size:14px;
    }
    
    .timer-bar{
      height:6px;
      margin-bottom:6px;
    }
    
    .timer-text{
      font-size:14px;
      margin-bottom:8px;
    }
    
    .divider{display:none;}
    
    canvas{
      border:4px solid #1f2530;
      border-radius:16px;
      max-width:100%;
      height:auto !important;
    }
    
    .modal-content{
      padding:30px 20px;
      max-width:90%;
      margin:0 15px;
    }
    
    .modal-title{
      font-size:36px;
      margin-bottom:15px;
    }
    
    .modal-subtitle{
      font-size:14px;
      margin-bottom:20px;
    }
    
    .modal-stats{
      padding:20px 15px;
      margin:20px 0;
    }
    
    .stat-row{
      margin:10px 0;
      padding:10px;
    }
    
    .stat-label{
      font-size:14px;
    }
    
    .stat-label.player{
      font-size:16px;
    }
    
    .stat-score{
      font-size:20px;
    }
    
    .modal-btn{
      padding:12px 30px;
      font-size:16px;
      margin:8px;
    }
    
    .countdown{
      font-size:72px;
    }
    
    .combo{
      font-size:18px;
    }
  }
  
  @media (max-width: 480px) {
    .menu-title{font-size:36px;}
    .logo{width:60px;height:60px;margin-bottom:20px;}
    .logo-icon{font-size:36px;}
    
    .modal-title{font-size:28px;}
    .countdown{font-size:60px;}
    
    .stat-value{font-size:18px;}
    .stat-label{font-size:8px;}
  }
</style>
</head>
<body>
  <!-- Menu Screen -->
  <div class="menu" id="menu">
    <div class="menu-content">
      <div class="logo">
        <div class="logo-icon">‚ú¶</div>
      </div>
      <div class="menu-title">DOTS CONNECTION</div>
      <div class="menu-subtitle">2-3 —Ç–æ—á–∫–∏: —à—Ç—Ä–∞—Ñ | 4-6: –Ω–æ—Ä–º–∞ | 7-9: +–≤—Ä–µ–º—è | 10+: –í–ó–†–´–í! üí•</div>
      
      <div class="mode-select">
        <div class="mode-btn active" data-mode="solo">
          <div class="mode-icon">üë§</div>
          <div class="mode-name">–°–æ–ª–æ</div>
          <div class="mode-desc">3 —Ä–∞—É–Ω–¥–∞ –ø–æ 60 —Å–µ–∫</div>
        </div>
        <div class="mode-btn" data-mode="duel">
          <div class="mode-icon">‚öîÔ∏è</div>
          <div class="mode-name">–î—É—ç–ª—å</div>
          <div class="mode-desc">–ë–∏—Ç–≤–∞ 1 –Ω–∞ 1</div>
        </div>
      </div>
      
      <button class="start-btn" id="startGame">üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <!-- Game Container -->
  <div class="game-container" id="gameContainer" style="display:none;">
    <!-- Player 1 Area -->
    <div class="player-area p1" id="p1Area">
      <div class="player-header">
        <div class="player-name p1">
          <span class="player-icon">üéØ</span>
          <span id="p1Name">–ò–≥—Ä–æ–∫ 1</span>
        </div>
      </div>
      
      <div class="stats-bar">
        <div class="stat">
          <div class="stat-label">–†–∞—É–Ω–¥</div>
          <div class="stat-value" id="p1Score">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">–í—Å–µ–≥–æ</div>
          <div class="stat-value" id="p1Total">0</div>
        </div>
      </div>
      
      <div class="rounds" id="p1Rounds">
        <div class="round p1">1</div>
        <div class="round p1">2</div>
        <div class="round p1">3</div>
      </div>
      
      <div class="timer-bar">
        <div class="timer-fill" id="p1TimerFill"></div>
      </div>
      <div class="timer-text" id="p1Timer">60</div>
      
      <canvas id="p1Canvas" width="280" height="420"></canvas>
    </div>

    <!-- VS Divider -->
    <div class="divider">
      <div class="vs-text">VS</div>
    </div>

    <!-- Player 2 Area -->
    <div class="player-area p2" id="p2Area">
      <div class="player-header">
        <div class="player-name p2">
          <span class="player-icon">üéØ</span>
          <span id="p2Name">–ò–≥—Ä–æ–∫ 2</span>
        </div>
      </div>
      
      <div class="stats-bar">
        <div class="stat">
          <div class="stat-label">–†–∞—É–Ω–¥</div>
          <div class="stat-value" id="p2Score">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">–í—Å–µ–≥–æ</div>
          <div class="stat-value" id="p2Total">0</div>
        </div>
      </div>
      
      <div class="rounds" id="p2Rounds">
        <div class="round p2">1</div>
        <div class="round p2">2</div>
        <div class="round p2">3</div>
      </div>
      
      <div class="timer-bar">
        <div class="timer-fill" id="p2TimerFill"></div>
      </div>
      <div class="timer-text" id="p2Timer">60</div>
      
      <canvas id="p2Canvas" width="280" height="420"></canvas>
    </div>
  </div>

  <!-- Round End Modal -->
  <div class="modal" id="roundEndModal">
    <div class="modal-content">
      <div class="modal-title">–†–ê–£–ù–î –ó–ê–í–ï–†–®–Å–ù!</div>
      <div class="modal-subtitle">–†–∞—É–Ω–¥ <span id="completedRound">1</span> –∏–∑ 3</div>
      <div class="modal-stats">
        <div class="stat-row">
          <span class="stat-label player p1" id="roundP1Name">–ò–≥—Ä–æ–∫ 1</span>
          <span class="stat-score p1" id="roundP1Score">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label player p2" id="roundP2Name">–ò–≥—Ä–æ–∫ 2</span>
          <span class="stat-score p2" id="roundP2Score">0</span>
        </div>
        <div class="stat-row final">
          <span class="stat-label">–õ–∏–¥–∏—Ä—É–µ—Ç:</span>
          <span class="stat-score" id="roundLeader">-</span>
        </div>
      </div>
      <div class="countdown" id="countdown">3</div>
      <div style="margin-top:20px;color:rgba(255,255,255,0.3);font-size:14px;">–°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥ –Ω–∞—á–Ω—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏...</div>
    </div>
  </div>

  <!-- Game Over Modal -->
  <div class="modal" id="gameOverModal">
    <div class="modal-content">
      <div class="modal-title" id="winnerTitle">–ü–û–ë–ï–î–ê!</div>
      <div class="modal-subtitle" id="winnerSubtitle">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
      <div class="modal-stats">
        <div class="stat-row">
          <span class="stat-label player p1" id="finalP1Name">–ò–≥—Ä–æ–∫ 1</span>
          <span class="stat-score p1" id="finalP1Score">0</span>
        </div>
        <div class="stat-row">
          <span class="stat-label player p2" id="finalP2Name">–ò–≥—Ä–æ–∫ 2</span>
          <span class="stat-score p2" id="finalP2Score">0</span>
        </div>
      </div>
      <button class="modal-btn" id="playAgain">üéÆ –ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
      <button class="modal-btn secondary" id="backToMenu">üè† –í –º–µ–Ω—é</button>
    </div>
  </div>

<script>
/* ==========================================
   –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø - –û–°–ù–û–í–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø:
   
   1. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ layout –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   2. ‚úÖ –û—á–∏—Å—Ç–∫–∞ event listeners –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ
   3. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤ –¥–ª—è 10+ —Ç–æ—á–µ–∫
   4. ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ combo —ç–ª–µ–º–µ–Ω—Ç–æ–≤
   5. ‚úÖ –õ—É—á—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏
   6. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è particles —Å–∏—Å—Ç–µ–º—ã
   7. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤
========================================== */

/* --- –ö–û–ù–°–¢–ê–ù–¢–´ --- */
const CONFIG = {
  ROWS: 6,
  COLS: 6,
  DOT_RADIUS: 26, // –£–≤–µ–ª–∏—á–µ–Ω —Å 22 –¥–æ 26
  GAP: 8,
  ROUND_TIME: 60,
  TOTAL_ROUNDS: 3,
  MAX_PARTICLES: 300, // –õ–∏–º–∏—Ç —á–∞—Å—Ç–∏—Ü –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  COLORS: ["#7fa5b8","#d17a6f","#e8b86d","#9b89b3"],
  TOUCH_RADIUS_MULTIPLIER: 1.5, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –¥–ª—è —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π
  ENABLE_PARTICLES: false, // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∞—Å—Ç–∏—Ü
  DOT_ANIMATION_SPEED: 0.50 // –°–∫–æ—Ä–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Ç–æ—á–µ–∫
};

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—á–∫–æ–≤ - –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –¥–ª—è 10+
const SCORING = {
  2: { points: 2, time: -5 },
  3: { points: 3, time: -5 },
  4: { points: 4, time: 0 },
  5: { points: 10, time: 0 },
  6: { points: 20, time: 0 },
  7: { points: 30, time: 3 },
  8: { points: 40, time: 3 },
  9: { points: 50, time: 3 },
  10: { points: 100, time: 5, explosion: true }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –æ—á–∫–æ–≤ –ø—Ä–∏ 10+ —Ç–æ—á–∫–∞—Ö (–ø—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è)
function calculateScore(chainLength) {
  if (chainLength < 10) {
    return SCORING[chainLength] || SCORING[3];
  }
  // –î–ª—è 10+ —Ç–æ—á–µ–∫: 100 –±–∞–∑–æ–≤—ã—Ö + 20 –∑–∞ –∫–∞–∂–¥—É—é —Ç–æ—á–∫—É —Å–≤–µ—Ä—Ö 10
  const baseScore = SCORING[10].points;
  const bonusPoints = (chainLength - 10) * 20;
  return {
    points: baseScore + bonusPoints,
    time: SCORING[10].time + Math.floor((chainLength - 10) / 2), // +0.5 —Å–µ–∫ –∑–∞ –∫–∞–∂–¥—ã–µ 2 —Ç–æ—á–∫–∏
    explosion: true
  };
}

/* --- –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ --- */
class GameState {
  constructor() {
    this.mode = 'solo';
    this.currentRound = 1;
    this.timeLeft = CONFIG.ROUND_TIME;
    this.timerInterval = null;
    this.animationId = null;
    this.gameComplete = false;
    this.comboElements = new Set(); // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ combo —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  }
  
  reset() {
    this.currentRound = 1;
    this.timeLeft = CONFIG.ROUND_TIME;
    this.gameComplete = false;
    this.clearComboElements();
  }
  
  clearComboElements() {
    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö combo —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    this.comboElements.forEach(el => {
      if (el && el.parentNode) {
        el.parentNode.removeChild(el);
      }
    });
    this.comboElements.clear();
  }
}

const gameState = new GameState();

/* --- –ò–ì–†–û–ö --- */
class Player {
  constructor(id) {
    this.id = id;
    this.grid = [];
    this.score = 0;
    this.totalScore = 0;
    this.roundScores = [0, 0, 0];
    this.chain = [];
    this.chainSet = new Set();
    this.dragging = false;
    this.lastPos = null;
    this.particles = [];
    this.canvas = null;
    this.ctx = null;
    this.layoutCache = null; // –ö—ç—à –ø–æ–∑–∏—Ü–∏–π
    this.eventListeners = []; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ listeners
  }
  
  initCanvas() {
    this.canvas = document.getElementById(this.id + 'Canvas');
    this.ctx = this.canvas.getContext('2d');
    this.updateLayoutCache();
  }
  
  updateLayoutCache() {
    // –ö—ç—à–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Ç–æ—á–µ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    const totalWidth = CONFIG.COLS * CONFIG.DOT_RADIUS * 2 + (CONFIG.COLS - 1) * CONFIG.GAP;
    const startX = (this.canvas.width - totalWidth) / 2 + CONFIG.DOT_RADIUS;
    const startY = 40;
    
    this.layoutCache = [];
    for (let r = 0; r < CONFIG.ROWS; r++) {
      const row = [];
      for (let c = 0; c < CONFIG.COLS; c++) {
        row.push({
          x: startX + c * (CONFIG.DOT_RADIUS * 2 + CONFIG.GAP),
          y: startY + r * (CONFIG.DOT_RADIUS * 2 + CONFIG.GAP)
        });
      }
      this.layoutCache.push(row);
    }
  }
  
  reset() {
    this.score = 0;
    this.totalScore = 0;
    this.roundScores = [0, 0, 0];
    this.chain = [];
    this.chainSet.clear();
    this.particles = [];
    this.dragging = false;
    this.lastPos = null;
  }
  
  addParticle(x, y, color, count = 10) {
    const [r, g, b] = hex2rgb(color);
    for (let i = 0; i < count; i++) {
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü
      if (this.particles.length >= CONFIG.MAX_PARTICLES) {
        this.particles.shift(); // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é
      }
      
      this.particles.push({
        x: x + (Math.random() - 0.5) * CONFIG.DOT_RADIUS,
        y: y + (Math.random() - 0.5) * CONFIG.DOT_RADIUS,
        vx: (Math.random() - 0.5) * 4,
        vy: (Math.random() - 0.5) * 4 - 2,
        size: Math.random() * 4 + 2,
        life: 1,
        r, g, b
      });
    }
  }
  
  // –û—á–∏—Å—Ç–∫–∞ event listeners
  removeEventListeners() {
    this.eventListeners.forEach(({element, event, handler}) => {
      element.removeEventListener(event, handler);
    });
    this.eventListeners = [];
  }
  
  addEventListener(element, event, handler) {
    element.addEventListener(event, handler);
    this.eventListeners.push({element, event, handler});
  }
}

const players = {
  p1: new Player('p1'),
  p2: new Player('p2')
};

/* --- –ê–£–î–ò–û --- */
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playSound(frequency, duration, type = 'sine', volume = 0.03) {
  try {
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    const oscillator = audioContext.createOscillator();
    const gain = audioContext.createGain();
    
    oscillator.connect(gain);
    gain.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    
    gain.gain.setValueAtTime(volume, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  } catch (e) {
    console.warn('Audio error:', e);
  }
}

/* --- GRID MANAGEMENT --- */
function fillGrid(player) {
  function hasPair() {
    for (let r = 0; r < CONFIG.ROWS; r++) {
      for (let c = 0; c < CONFIG.COLS; c++) {
        const col = player.grid[r][c].color;
        if (r + 1 < CONFIG.ROWS && player.grid[r + 1][c].color === col) return true;
        if (c + 1 < CONFIG.COLS && player.grid[r][c + 1].color === col) return true;
        if (r + 1 < CONFIG.ROWS && c + 1 < CONFIG.COLS && player.grid[r + 1][c + 1].color === col) return true;
        if (r + 1 < CONFIG.ROWS && c - 1 >= 0 && player.grid[r + 1][c - 1].color === col) return true;
      }
    }
    return false;
  }
  
  let attempts = 0;
  do {
    if (attempts++ > 100) {
      console.warn('Failed to generate valid grid after 100 attempts');
      break;
    }
    player.grid = [];
    for (let r = 0; r < CONFIG.ROWS; r++) {
      const row = [];
      for (let c = 0; c < CONFIG.COLS; c++) {
        row.push({ color: Math.floor(Math.random() * CONFIG.COLORS.length), y: 0 });
      }
      player.grid.push(row);
    }
  } while (!hasPair());
}

/* --- –†–ï–ù–î–ï–†–ò–ù–ì --- */
function draw(player) {
  const ctx = player.ctx;
  const canvas = player.canvas;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const pos = player.layoutCache; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à!

  // –õ–∏–Ω–∏—è —Ü–µ–ø–æ—á–∫–∏
  if (player.chain.length > 0) {
    ctx.save();
    
    ctx.beginPath();
    for (let i = 0; i < player.chain.length; i++) {
      const p = pos[player.chain[i].r][player.chain[i].c];
      const dot = player.grid[player.chain[i].r][player.chain[i].c];
      if (i === 0) ctx.moveTo(p.x, p.y + dot.y);
      else ctx.lineTo(p.x, p.y + dot.y);
    }
    if (player.lastPos) ctx.lineTo(player.lastPos.x, player.lastPos.y);
    
    ctx.strokeStyle = "rgba(255,255,255,0.4)";
    ctx.lineWidth = 14;
    ctx.lineCap = "round";
    ctx.shadowColor = "rgba(255,255,255,0.5)";
    ctx.shadowBlur = 15;
    ctx.stroke();
    
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineWidth = 6;
    ctx.shadowBlur = 5;
    ctx.stroke();
    
    ctx.restore();
  }

  // –¢–æ—á–∫–∏
  for (let r = 0; r < CONFIG.ROWS; r++) {
    for (let c = 0; c < CONFIG.COLS; c++) {
      const d = player.grid[r][c];
      const p = pos[r][c];
      const isSelected = player.chainSet.has(r + "," + c);
      
      ctx.save();
      
      // –¢–µ–Ω—å
      ctx.beginPath();
      ctx.fillStyle = "rgba(0,0,0,0.2)";
      ctx.arc(p.x + 2, p.y + d.y + 2, CONFIG.DOT_RADIUS, 0, Math.PI * 2);
      ctx.fill();
      
      // –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞
      ctx.beginPath();
      ctx.fillStyle = CONFIG.COLORS[d.color];
      
      if (isSelected) {
        ctx.shadowColor = CONFIG.COLORS[d.color];
        ctx.shadowBlur = 20;
      }
      
      ctx.arc(p.x, p.y + d.y, CONFIG.DOT_RADIUS, 0, Math.PI * 2);
      ctx.fill();
      
      // –ö–æ–ª—å—Ü–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è
      if (isSelected) {
        ctx.beginPath();
        ctx.strokeStyle = "rgba(255,255,255,0.9)";
        ctx.lineWidth = 3;
        ctx.shadowColor = "white";
        ctx.shadowBlur = 15;
        ctx.arc(p.x, p.y + d.y, CONFIG.DOT_RADIUS + 3, 0, Math.PI * 2);
        ctx.stroke();
      }
      
      ctx.restore();
    }
  }

  // –ß–∞—Å—Ç–∏—Ü—ã —Å —Å–≤–µ—á–µ–Ω–∏–µ–º
  if (CONFIG.ENABLE_PARTICLES) {
    player.particles = player.particles.filter(pt => {
      if (pt.life <= 0) return false;
      
      ctx.save();
      ctx.beginPath();
      
      // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è
      const glowGradient = ctx.createRadialGradient(pt.x, pt.y, 0, pt.x, pt.y, pt.size * 2);
      glowGradient.addColorStop(0, `rgba(${pt.r},${pt.g},${pt.b},${pt.life})`);
      glowGradient.addColorStop(0.5, `rgba(${pt.r},${pt.g},${pt.b},${pt.life * 0.5})`);
      glowGradient.addColorStop(1, `rgba(${pt.r},${pt.g},${pt.b},0)`);
      
      ctx.fillStyle = glowGradient;
      ctx.arc(pt.x, pt.y, pt.size * 2, 0, Math.PI * 2);
      ctx.fill();
      
      // –Ø–¥—Ä–æ
      ctx.fillStyle = `rgba(${pt.r},${pt.g},${pt.b},${pt.life})`;
      ctx.arc(pt.x, pt.y, pt.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
      
      pt.x += pt.vx;
      pt.y += pt.vy;
      pt.vy += 0.1;
      pt.life -= 0.015;
      pt.size *= 0.99;
      
      return true;
    });
  }
}

/* --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò --- */
function hex2rgb(hex) {
  const v = parseInt(hex.slice(1), 16);
  return [v >> 16 & 255, v >> 8 & 255, v & 255];
}

function nearestCell(p, player, isTouch = false) {
  const pos = player.layoutCache;
  let nearest = null;
  let minDist = Infinity;
  
  // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –¥–ª—è —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π
  const hitRadius = isTouch 
    ? CONFIG.DOT_RADIUS * CONFIG.TOUCH_RADIUS_MULTIPLIER 
    : CONFIG.DOT_RADIUS;
  
  for (let r = 0; r < CONFIG.ROWS; r++) {
    for (let c = 0; c < CONFIG.COLS; c++) {
      const dot = player.grid[r][c];
      const d = Math.hypot(p.x - pos[r][c].x, p.y - (pos[r][c].y + dot.y));
      if (d < hitRadius && d < minDist) {
        minDist = d;
        nearest = { r, c };
      }
    }
  }
  return nearest;
}

function neighbors(a, b) {
  return Math.abs(a.r - b.r) <= 1 && Math.abs(a.c - b.c) <= 1 && !(a.r === b.r && a.c === b.c);
}

function getPos(e, canvas) {
  const rect = canvas.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return { x: clientX - rect.left, y: clientY - rect.top };
}

function showCombo(text, x, y, playerClass) {
  const comboEl = document.createElement('div');
  comboEl.className = `combo ${playerClass}`;
  comboEl.textContent = text;
  comboEl.style.left = x + 'px';
  comboEl.style.top = y + 'px';
  document.body.appendChild(comboEl);
  
  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
  gameState.comboElements.add(comboEl);
  
  setTimeout(() => {
    if (document.body.contains(comboEl)) {
      document.body.removeChild(comboEl);
    }
    gameState.comboElements.delete(comboEl);
  }, 1000);
}

/* --- –°–û–ë–´–¢–ò–Ø –í–í–û–î–ê --- */
function createInputHandlers(player) {
  const start = (e) => {
    if (gameState.gameComplete) return;
    e.preventDefault();
    
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }
    
    player.dragging = true;
    player.chain = [];
    player.chainSet.clear();
    
    const p = getPos(e, player.canvas);
    const isTouch = e.type.includes('touch');
    const cell = nearestCell(p, player, isTouch);
    if (cell) {
      player.chain.push(cell);
      player.chainSet.add(cell.r + "," + cell.c);
      playSound(300, 0.05);
      
      // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–µ—Ä–≤–æ–π —Ç–æ—á–∫–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
      if (isTouch && navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
    player.lastPos = p;
    draw(player);
  };
  
  const move = (e) => {
    if (!player.dragging || gameState.gameComplete) return;
    e.preventDefault(); // –í–∞–∂–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
    
    const p = getPos(e, player.canvas);
    player.lastPos = p;
    const isTouch = e.type.includes('touch');
    const cell = nearestCell(p, player, isTouch);
    
    if (cell) {
      const last = player.chain[player.chain.length - 1];
      if (last && neighbors(last, cell) &&
          player.grid[cell.r][cell.c].color === player.grid[last.r][last.c].color &&
          !player.chainSet.has(cell.r + "," + cell.c)) {
        player.chain.push(cell);
        player.chainSet.add(cell.r + "," + cell.c);
        playSound(400 + player.chain.length * 30, 0.05);
        
        // –õ—ë–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ—á–∫–∏
        if (isTouch && navigator.vibrate) {
          navigator.vibrate(5);
        }
      }
    }
    draw(player);
  };
  
  const end = (e) => {
    if (!player.dragging || gameState.gameComplete) return;
    player.dragging = false;
    player.lastPos = null;
    
    if (player.chain.length >= 2) {
      processChain(player);
    }
    
    player.chain = [];
    player.chainSet.clear();
    draw(player);
  };
  
  return { start, move, end };
}

/* --- –û–ë–†–ê–ë–û–¢–ö–ê –¶–ï–ü–û–ß–ö–ò --- */
function processChain(player) {
  const pos = player.layoutCache;
  const color = player.grid[player.chain[0].r][player.chain[0].c].color;
  const chainLength = player.chain.length;
  
  // –ü–æ–ª—É—á–∞–µ–º –æ—á–∫–∏ (—É–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
  const scoring = calculateScore(chainLength);
  
  const rect = player.canvas.getBoundingClientRect();

  // –°–æ–∑–¥–∞—ë–º —á–∞—Å—Ç–∏—Ü—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
  if (CONFIG.ENABLE_PARTICLES) {
    player.chain.forEach(c => {
      const p = pos[c.r][c.c];
      const particleCount = Math.min(chainLength + 5, 20);
      player.addParticle(p.x, p.y, CONFIG.COLORS[color], particleCount);
    });
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∑—Ä—ã–≤–∞ (10+ —Ç–æ—á–µ–∫)
  if (scoring.explosion && chainLength >= 10) {
    // –ú–∞—Å—Å–∏–≤–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤–∑—Ä—ã–≤–∞
    playSound(900, 0.3, 'sine', 0.06);
    if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
    
    // –ß–∞—Å—Ç–∏—Ü—ã –ø–æ –≤—Å–µ–π –¥–æ—Å–∫–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã)
    if (CONFIG.ENABLE_PARTICLES) {
      for (let r = 0; r < CONFIG.ROWS; r++) {
        for (let c = 0; c < CONFIG.COLS; c++) {
          const p = pos[r][c];
          const dotColor = player.grid[r][c].color;
          player.addParticle(p.x, p.y, CONFIG.COLORS[dotColor], 15);
        }
      }
    }
    
    // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ–π —Å–µ—Ç–∫–∏
    fillGrid(player);
    
    showCombo(`üí• –í–ó–†–´–í! +${scoring.points}`, rect.left + rect.width / 2, rect.top + rect.height / 2, player.id);
    
  } else {
    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º: –º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
    player.chain.forEach(c => {
      player.grid[c.r][c.c].color = Math.floor(Math.random() * CONFIG.COLORS.length);
    });
  }

  // –ù–∞—á–∏—Å–ª—è–µ–º –æ—á–∫–∏
  player.score += scoring.points;
  
  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
  if (scoring.time !== 0) {
    gameState.timeLeft = Math.max(0, Math.min(CONFIG.ROUND_TIME, gameState.timeLeft + scoring.time));
    updateTimer();
    
    const scoreEl = document.getElementById(player.id + 'Score');
    
    if (scoring.time < 0) {
      // –®—Ç—Ä–∞—Ñ
      scoreEl.classList.remove('bonus');
      scoreEl.classList.add('penalty');
      setTimeout(() => scoreEl.classList.remove('penalty'), 500);
      
      playSound(200, 0.1, 'square', 0.02);
      showCombo(`${scoring.time}—Å`, rect.left + rect.width / 2, rect.top + rect.height / 2 + 30, player.id);
      
    } else if (scoring.time > 0) {
      // –ë–æ–Ω—É—Å –≤—Ä–µ–º–µ–Ω–∏
      scoreEl.classList.remove('penalty');
      scoreEl.classList.add('bonus');
      setTimeout(() => scoreEl.classList.remove('bonus'), 500);
      
      playSound(700, 0.15, 'sine', 0.05);
      showCombo(`+${scoring.time}—Å ‚è±Ô∏è`, rect.left + rect.width / 2, rect.top + rect.height / 2 + 30, player.id);
    }
  } else {
    // –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
    const scoreEl = document.getElementById(player.id + 'Score');
    scoreEl.classList.remove('penalty');
    scoreEl.classList.add('bonus');
    setTimeout(() => scoreEl.classList.remove('bonus'), 300);
    
    playSound(500 + chainLength * 50, 0.1, 'sine', 0.04);
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–±–æ –æ—á–∫–æ–≤
  if (!scoring.explosion || chainLength < 10) {
    showCombo(`+${scoring.points}`, rect.left + rect.width / 2, rect.top + rect.height / 2, player.id);
  }
  
  document.getElementById(player.id + 'Score').textContent = player.score;
  updateTotalScore(player);
}

/* --- –°–ò–°–¢–ï–ú–ê –†–ê–£–ù–î–û–í --- */
function updateRoundIndicator(player) {
  const rounds = document.querySelectorAll(`#${player.id}Rounds .round`);
  rounds.forEach((round, idx) => {
    round.classList.remove('active', 'completed');
    
    if (idx + 1 < gameState.currentRound) {
      round.classList.add('completed');
    } else if (idx + 1 === gameState.currentRound) {
      round.classList.add('active');
    }
  });
}

function updateTotalScore(player) {
  player.roundScores[gameState.currentRound - 1] = player.score;
  player.totalScore = player.roundScores.reduce((a, b) => a + b, 0);
  document.getElementById(player.id + 'Total').textContent = player.totalScore;
  updateRoundIndicator(player);
}

function updateTimer() {
  const progress = (gameState.timeLeft / CONFIG.ROUND_TIME) * 100;
  
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    
    const timerEl = document.getElementById(playerId + 'Timer');
    const fillEl = document.getElementById(playerId + 'TimerFill');
    
    timerEl.textContent = gameState.timeLeft;
    fillEl.style.width = progress + '%';
    
    if (gameState.timeLeft <= 10) {
      timerEl.classList.add('warning');
    } else {
      timerEl.classList.remove('warning');
    }
  });
}

function startTimer() {
  clearInterval(gameState.timerInterval);
  gameState.timeLeft = CONFIG.ROUND_TIME;
  
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    
    document.getElementById(playerId + 'Timer').classList.remove('warning');
    document.getElementById(playerId + 'TimerFill').style.width = '100%';
  });
  
  updateTimer();
  
  gameState.timerInterval = setInterval(() => {
    gameState.timeLeft--;
    updateTimer();
    
    if (gameState.timeLeft <= 5 && gameState.timeLeft > 0) {
      playSound(800, 0.1, 'sine', 0.02);
    }
    
    if (gameState.timeLeft <= 0) {
      endRound();
    }
  }, 1000);
}

function endRound() {
  clearInterval(gameState.timerInterval);
  
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    const player = players[playerId];
    player.roundScores[gameState.currentRound - 1] = player.score;
    player.totalScore = player.roundScores.reduce((a, b) => a + b, 0);
  });
  
  if (gameState.currentRound < CONFIG.TOTAL_ROUNDS) {
    showRoundEndModal();
  } else {
    endGame();
  }
}

function showRoundEndModal() {
  document.getElementById('completedRound').textContent = gameState.currentRound;
  
  if (gameState.mode === 'duel') {
    document.getElementById('roundP1Score').textContent = players.p1.totalScore;
    document.getElementById('roundP2Score').textContent = players.p2.totalScore;
    
    const leaderEl = document.getElementById('roundLeader');
    if (players.p1.totalScore > players.p2.totalScore) {
      leaderEl.textContent = '–ò–≥—Ä–æ–∫ 1';
      leaderEl.className = 'stat-score p1';
    } else if (players.p2.totalScore > players.p1.totalScore) {
      leaderEl.textContent = '–ò–≥—Ä–æ–∫ 2';
      leaderEl.className = 'stat-score p2';
    } else {
      leaderEl.textContent = '–ù–∏—á—å—è';
      leaderEl.className = 'stat-score';
    }
  } else {
    document.getElementById('roundP1Score').textContent = players.p1.totalScore;
    document.querySelector('#roundEndModal .stat-row:nth-child(2)').style.display = 'none';
    document.querySelector('#roundEndModal .stat-row.final').style.display = 'none';
  }
  
  document.getElementById('roundEndModal').style.display = 'flex';
  
  let countdown = 3;
  const countdownEl = document.getElementById('countdown');
  countdownEl.textContent = countdown;
  
  const countdownInterval = setInterval(() => {
    countdown--;
    if (countdown > 0) {
      countdownEl.textContent = countdown;
      playSound(600, 0.1);
    } else {
      clearInterval(countdownInterval);
      document.getElementById('roundEndModal').style.display = 'none';
      startNextRound();
    }
  }, 1000);
}

function startNextRound() {
  gameState.currentRound++;
  
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    
    const player = players[playerId];
    player.score = 0;
    document.getElementById(playerId + 'Score').textContent = 0;
    document.getElementById(playerId + 'Score').classList.remove('bonus', 'penalty');
    updateRoundIndicator(player);
    
    fillGrid(player);
    player.chain = [];
    player.chainSet.clear();
    player.particles = [];
  });
  
  startTimer();
}

function endGame() {
  gameState.gameComplete = true;
  
  const p1Total = players.p1.totalScore;
  const p2Total = players.p2.totalScore;
  
  document.getElementById('finalP1Score').textContent = p1Total;
  document.getElementById('finalP2Score').textContent = p2Total;
  
  const titleEl = document.getElementById('winnerTitle');
  const subtitleEl = document.getElementById('winnerSubtitle');
  
  // –û—á–∏—Å—Ç–∫–∞ –∫–ª–∞—Å—Å–æ–≤ winner
  document.querySelectorAll('#gameOverModal .stat-row').forEach(row => row.classList.remove('winner'));
  
  if (gameState.mode === 'duel') {
    if (p1Total > p2Total) {
      titleEl.textContent = 'üèÜ –ü–û–ë–ï–î–ê –ò–ì–†–û–ö–ê 1!';
      titleEl.style.color = '#7fa5b8';
      subtitleEl.textContent = `${p1Total} vs ${p2Total}`;
      document.querySelectorAll('#gameOverModal .stat-row')[0].classList.add('winner');
    } else if (p2Total > p1Total) {
      titleEl.textContent = 'üèÜ –ü–û–ë–ï–î–ê –ò–ì–†–û–ö–ê 2!';
      titleEl.style.color = '#d17a6f';
      subtitleEl.textContent = `${p1Total} vs ${p2Total}`;
      document.querySelectorAll('#gameOverModal .stat-row')[1].classList.add('winner');
    } else {
      titleEl.textContent = 'ü§ù –ù–ò–ß–¨–Ø!';
      titleEl.style.color = '#e8b86d';
      subtitleEl.textContent = `${p1Total} - ${p2Total}`;
    }
    document.querySelector('#gameOverModal .stat-row:nth-child(2)').style.display = 'flex';
  } else {
    const avgScore = p1Total / 3;
    if (avgScore >= 800) {
      titleEl.textContent = 'üî• –ù–ï–í–ï–†–û–Ø–¢–ù–û!';
      titleEl.style.color = '#d17a6f';
    } else if (avgScore >= 600) {
      titleEl.textContent = 'üöÄ –§–ê–ù–¢–ê–°–¢–ò–ö–ê!';
      titleEl.style.color = '#7fa5b8';
    } else if (avgScore >= 400) {
      titleEl.textContent = 'üèÜ –ü–†–ï–í–û–°–•–û–î–ù–û!';
      titleEl.style.color = '#7fa5b8';
    } else {
      titleEl.textContent = 'üëç –•–û–†–û–®–ê–Ø –ò–ì–†–ê!';
      titleEl.style.color = '#9b89b3';
    }
    subtitleEl.textContent = `–ò—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç: ${p1Total}`;
    document.querySelector('#gameOverModal .stat-row:nth-child(2)').style.display = 'none';
  }
  
  document.getElementById('gameOverModal').style.display = 'flex';
}

/* --- –ê–ù–ò–ú–ê–¶–ò–û–ù–ù–´–ô –¶–ò–ö–õ --- */
function loop() {
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    draw(players[playerId]);
  });
  
  if (!gameState.gameComplete) {
    gameState.animationId = requestAnimationFrame(loop);
  }
}

/* --- –ó–ê–ü–£–°–ö –ò–ì–†–´ --- */
function startGame() {
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é
  if (gameState.animationId) {
    cancelAnimationFrame(gameState.animationId);
  }
  
  // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ event listeners
  Object.values(players).forEach(player => player.removeEventListeners());
  
  gameState.reset();
  
  Object.keys(players).forEach(playerId => {
    if (gameState.mode === 'solo' && playerId === 'p2') return;
    
    const player = players[playerId];
    player.reset();
    
    document.getElementById(playerId + 'Score').textContent = 0;
    document.getElementById(playerId + 'Total').textContent = 0;
    document.getElementById(playerId + 'Score').classList.remove('bonus', 'penalty');
    
    fillGrid(player);
    updateRoundIndicator(player);
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ event listeners
    const handlers = createInputHandlers(player);
    
    player.addEventListener(player.canvas, "mousedown", handlers.start);
    player.addEventListener(player.canvas, "mousemove", handlers.move);
    player.addEventListener(window, "mouseup", handlers.end);
    
    // –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ç–∞—á-—Å–æ–±—ã—Ç–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º passive
    const touchStartHandler = (e) => {
      e.preventDefault();
      handlers.start(e);
    };
    const touchMoveHandler = (e) => {
      e.preventDefault();
      handlers.move(e);
    };
    
    player.canvas.addEventListener("touchstart", touchStartHandler, {passive: false});
    player.canvas.addEventListener("touchmove", touchMoveHandler, {passive: false});
    player.eventListeners.push(
      {element: player.canvas, event: "touchstart", handler: touchStartHandler},
      {element: player.canvas, event: "touchmove", handler: touchMoveHandler}
    );
    
    player.addEventListener(window, "touchend", handlers.end);
    player.addEventListener(player.canvas, 'contextmenu', e => e.preventDefault());
  });
  
  document.getElementById('gameOverModal').style.display = 'none';
  document.getElementById('roundEndModal').style.display = 'none';
  
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∫ –≤ –º–æ–¥–∞–ª–∫–∞—Ö
  document.querySelector('#roundEndModal .stat-row:nth-child(2)').style.display = 'flex';
  document.querySelector('#roundEndModal .stat-row.final').style.display = 'flex';
  
  startTimer();
  loop();
}

/* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ CANVAS --- */
function resizeCanvas() {
  const isMobile = window.innerWidth <= 768;
  const isSmallMobile = window.innerWidth <= 480;
  
  if (gameState.mode === 'solo') {
    if (isMobile) {
      const maxWidth = Math.min(window.innerWidth - 40, 420);
      const maxHeight = Math.min(window.innerHeight * 0.6, 600);
      players.p1.canvas.width = maxWidth;
      players.p1.canvas.height = maxHeight;
    } else {
      players.p1.canvas.width = 420;
      players.p1.canvas.height = 560;
    }
    players.p1.updateLayoutCache();
  } else {
    if (isMobile) {
      const maxWidth = Math.min(window.innerWidth - 40, 380);
      const maxHeight = Math.min((window.innerHeight - 180) / 2, 450);
      
      players.p1.canvas.width = maxWidth;
      players.p1.canvas.height = maxHeight;
      players.p2.canvas.width = maxWidth;
      players.p2.canvas.height = maxHeight;
    } else {
      players.p1.canvas.width = 280;
      players.p1.canvas.height = 420;
      players.p2.canvas.width = 280;
      players.p2.canvas.height = 420;
    }
    players.p1.updateLayoutCache();
    players.p2.updateLayoutCache();
  }
}

/* --- –ú–ï–ù–Æ --- */
document.querySelectorAll('.mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    gameState.mode = btn.dataset.mode;
  });
});

document.getElementById('startGame').addEventListener('click', () => {
  document.getElementById('menu').style.display = 'none';
  document.getElementById('gameContainer').style.display = 'flex';
  
  if (gameState.mode === 'solo') {
    document.getElementById('p2Area').style.display = 'none';
    document.querySelector('.divider').style.display = 'none';
    document.getElementById('p1Area').style.flex = '1';
  } else {
    document.getElementById('p2Area').style.display = 'flex';
    document.querySelector('.divider').style.display = 'none'; // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ —Å–∫—Ä—ã—Ç
    if (window.innerWidth > 768) {
      document.querySelector('.divider').style.display = 'flex';
    }
  }
  
  resizeCanvas();
  startGame();
});

document.getElementById('backToMenu').addEventListener('click', () => {
  // –û—á–∏—â–∞–µ–º –≤—Å—ë –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –≤ –º–µ–Ω—é
  if (gameState.animationId) {
    cancelAnimationFrame(gameState.animationId);
  }
  clearInterval(gameState.timerInterval);
  gameState.clearComboElements();
  Object.values(players).forEach(player => player.removeEventListeners());
  
  document.getElementById('gameOverModal').style.display = 'none';
  document.getElementById('gameContainer').style.display = 'none';
  document.getElementById('menu').style.display = 'flex';
});

document.getElementById('playAgain').addEventListener('click', () => {
  document.getElementById('gameOverModal').style.display = 'none';
  resizeCanvas();
  startGame();
});

/* --- –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ –ü–†–ò –ò–ó–ú–ï–ù–ï–ù–ò–ò –†–ê–ó–ú–ï–†–ê --- */
let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    if (document.getElementById('gameContainer').style.display === 'flex') {
      resizeCanvas();
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∏–≤–∞–π–¥–µ—Ä
      if (gameState.mode === 'duel') {
        if (window.innerWidth > 768) {
          document.querySelector('.divider').style.display = 'flex';
        } else {
          document.querySelector('.divider').style.display = 'none';
        }
      }
    }
  }, 250);
});

/* --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø --- */
players.p1.initCanvas();
players.p2.initCanvas();
</script>
</body>
</html>
